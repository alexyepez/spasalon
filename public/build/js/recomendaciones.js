document.addEventListener("DOMContentLoaded",(function(){let e=null,n=null;const o=document.getElementById("modal-recomendaciones"),a=document.getElementById("cliente-recomendaciones-nombre"),c=document.getElementById("recomendaciones-loading"),r=document.getElementById("recomendaciones-contenedor"),t=document.getElementById("recomendaciones-vacio"),i=document.getElementById("recomendaciones-error"),s=document.getElementById("btn-generar-recomendaciones"),d=document.getElementById("btn-cerrar-recomendaciones"),l=document.getElementById("btn-cerrar-modal-recomendaciones");function m(){o.style.display="none",e=null,n=null}async function p(){var n;if(e)try{console.log("Iniciando carga de recomendaciones para cliente ID:",e);const o=new FormData;o.append("cliente_id",e),console.log("Enviando solicitud a /api/recomendaciones/obtener");const a=await fetch("/api/recomendaciones/obtener",{method:"POST",body:o});console.log("Respuesta recibida, status:",a.status);const s=await a.text();console.log("Respuesta texto:",s);try{const e=JSON.parse(s);console.log("Respuesta parseada:",e),c.style.display="none",e.resultado&&e.recomendaciones&&e.recomendaciones.length>0?(console.log("Mostrando",e.recomendaciones.length,"recomendaciones"),n=e.recomendaciones,r.innerHTML="",n.forEach((e=>{let n="";switch(parseInt(e.prioridad)){case 5:n="prioridad-muy-alta";break;case 4:n="prioridad-alta";break;case 3:n="prioridad-media";break;case 2:n="prioridad-baja";break;case 1:n="prioridad-muy-baja";break;default:n=""}let o="Fecha no disponible";if(e.fecha_creacion){console.log("Fecha original:",e.fecha_creacion);const n=new Date(e.fecha_creacion);if(n&&n.getFullYear()>2e3)o=n.toLocaleDateString();else{const n=e.fecha_creacion.split(/[- :]/);if(n.length>=3){const e=new Date(parseInt(n[0]),parseInt(n[1])-1,parseInt(n[2]));e&&e.getFullYear()>2e3&&(o=e.toLocaleDateString())}}}let a="";1==e.generado_por_ia?(a="IA",e.colaborador_nombre&&(a+=" (solicitado por "+e.colaborador_nombre+" "+e.colaborador_apellido+")")):a=e.colaborador_nombre+" "+e.colaborador_apellido;const c=document.createElement("div");c.className=`recomendacion-tarjeta ${n}`;let t="";e.servicio_nombre&&(t=`\n                    <div class="recomendacion-servicio">\n                        <h4>${e.servicio_nombre}</h4>\n                        <p class="recomendacion-meta">\n                            ${e.duracion?"Duración: "+e.duracion+" min • ":""}\n                            ${e.precio?"Precio: $"+e.precio:""}\n                        </p>\n                    </div>\n                `),c.innerHTML=`\n                <div class="recomendacion-encabezado">\n                    <div class="recomendacion-prioridad" title="Prioridad: ${e.prioridad}">\n                        ${"★".repeat(parseInt(e.prioridad))}\n                        ${"☆".repeat(5-parseInt(e.prioridad))}\n                    </div>\n                </div>\n                \n                ${t}\n                \n                <div class="recomendacion-descripcion">\n                    <p>${e.descripcion}</p>\n                </div>\n                \n                <div class="recomendacion-justificacion">\n                    <details>\n                        <summary>Ver justificación</summary>\n                        <p>${e.justificacion}</p>\n                    </details>\n                </div>\n                \n                <div class="recomendacion-meta">\n                    <small>Generado por ${a} • ${o}</small>\n                </div>\n            `,r.appendChild(c)})),r.style.display="grid"):(console.log("No hay recomendaciones para mostrar"),t.style.display="block")}catch(e){console.error("Error al parsear JSON:",e),c.style.display="none",i.style.display="block"}}catch(e){console.error("Error al cargar recomendaciones:",e),c.style.display="none",i.style.display="block"}}document.querySelectorAll(".ver-recomendaciones").forEach((s=>{s.addEventListener("click",(function(){e=this.dataset.clienteId,n=this.dataset.clienteNombre,function(){if(!e)return;a.textContent=`Recomendaciones para: ${n}`,r.innerHTML="",t.style.display="none",i.style.display="none",c.style.display="block",o.style.display="block",p()}()}))})),d&&d.addEventListener("click",m),l&&l.addEventListener("click",m),s&&s.addEventListener("click",(async function(){if(!e)return;r.innerHTML="",t.style.display="none",i.style.display="none",c.style.display="block";try{console.log("Iniciando generación de recomendaciones para cliente ID:",e);const n=new FormData;n.append("cliente_id",e),console.log("Enviando solicitud a /api/recomendaciones/generar");const o=await fetch("/api/recomendaciones/generar",{method:"POST",body:n});console.log("Respuesta recibida, status:",o.status);const a=await o.text();console.log("Respuesta texto:",a);try{const e=JSON.parse(a);console.log("Respuesta parseada:",e),c.style.display="none",e.resultado&&e.recomendaciones&&e.recomendaciones.length>0?(console.log("Recomendaciones generadas con éxito, recargando..."),p()):(e.mensaje&&(console.error("Error de API:",e.mensaje),i.querySelector("p").textContent=e.mensaje),i.style.display="block")}catch(e){console.error("Error al parsear JSON:",e),c.style.display="none",i.style.display="block"}}catch(e){console.error("Error al generar recomendaciones:",e),c.style.display="none",i.style.display="block"}}))}));